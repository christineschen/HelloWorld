<!DOCTYPE html>
<html lang="en">

  <head>
    <title>ChitChat</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="static/css/jquery-ui.min.css">
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="static/css/style.css">
  </head>

  <body>

    <div class="container">

      <h1>ChitChat</h1>
      <em class="webscale">Webscale Edition</em>

      <div class="login" style="display: none;">
        <div class="row loginForm">
          <div class="col-md-4">
            <h2>Login/Register</h2>
            <form id="loginRegister" action="">
              <input type="text" class="form-control" id="username" placeholder="Username">
              <input type="password" class="form-control" id="password" placeholder="Password">
              <input type="submit" class="form-control" id="submit_login" value="Login">
              <input type="submit" class="form-control" id="submit_register" value="Register">
            </form>
          </div>
        </div>
      </div>

      <div class="chat" style="display: none">
        <div class="row">
          <div class="room"></div>
        </div>
        <div class="row newMessage">
          <div class="col-md-12">
            <form id="sendMessage" action="">
              <textarea cols="40" rows="5" class="form-control" id="newMessage" placeholder="Enter a message"></textarea>
            </form>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 status">Disconnected</div>
        </div>
      </div>

      <footer>
        <p><a id="logout" href="#" style="display: none;">Logout</a></p>
        <p><a href="https://bit.ly/UTWorkshop2019">Tutorial</a> &middot; <a href="https://www.mongodb.org">MongoDB</a></p>
      </footer>

    </div>

    <script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.5.0/stitch.js"></script>
    <script src="static/js/jquery.min.js"></script>
    <script src="static/js/jquery-ui.min.js"></script>
    <script src="static/js/underscore-min.js"></script>
    <script src="static/js/bootstrap.min.js"></script>
    <script src="static/js/socket.io.js"></script>
    <script src="static/js/moment.min.js"></script>
    <script src="static/js/showdown.min.js"></script>

    <script>
      $(document).ready(function() {

        setTimeout(function() { $('.webscale').effect('fade', 1000); }, 2000);
        const client = stitch.Stitch.initializeDefaultAppClient('0910-sdeap');
        const chatDb = client.getServiceClient(stitch.RemoteMongoClient.factory, 'mongodb-atlas').db('chat');
        const messagesCollection = chatDb.collection('messages');
        const usersCollection = chatDb.collection('users');

        $('form#loginRegister').click(function(e){
          e.preventDefault();
          var username = $('#username').val();
          var password = $('#password').val();
          if ($(e.target).attr('id') === 'submit_register') {
            if (!(username && password)) {
              return;
            }
            const emailPasswordClient = client.auth
              .getProviderClient(stitch.UserPasswordAuthProviderClient.factory);

            emailPasswordClient.registerWithEmail(username, password)
              .then(() => {
                login(username, password).then(user => {
                  usersCollection.insertOne({
                    'user_id': user.id,
                    'username': username,
                  }).then(() => {
                    initChat(user, username);
                  });
                }).catch(err => {
                  console.error(err)
                });
              })
              .catch(err => console.error("Error registering new user:", err));
          } else if ($(e.target).attr('id') === 'submit_login') {
            if (!(username && password)) {
              return;
            }
            login(username, password).then(user => {
              initChat(user, username);
            }).catch(err => {
              console.error(err)
            });
          }
        });

        function login(username, password) {
          return client.auth.loginWithCredential(new stitch.UserPasswordCredential(username, password));
        }

        $('#logout').click(function(e){
          e.preventDefault();
          if (!client.auth.isLoggedIn) {
            return;
          }
          client.auth.logout().then(() => {
            $('.chat').hide();
            $('#logout').hide();
            $('.login').show();
          });
        });

        if (client.auth.isLoggedIn) {
          usersCollection.findOne({user_id: client.auth.user.id}).then(user => {
            initChat(client.auth.user, user.username);
          })
        } else {
          $('.login').show();
        }
        function initChat(user, username) {
          $('.login').hide();
          $('#logout').show();
          $('.chat').show();
          connectedOnce = false;
          const handleEnter = evt => {
            if (evt.keyCode != 13) {
              return;
            }
            evt.preventDefault();
            if (evt.shiftKey) {
              $('#newMessage').val($('#newMessage').val() + '\n');
              return;
            }
            var messageInput = $('#newMessage');
            var message  = messageInput.val();
            if (message != '') {
              messagesCollection.insertOne({
                'user_id': user.id,
                'username': username,
                'message': message,
                'postedOn': moment().unix() * 1000
              });
              // Clear  input
              messageInput.val('');
            }
            return;
          };
          $('form#sendMessage').keydown(handleEnter).keypress(handleEnter);
          startChat();
        }

        function startChat() {
          messagesCollection.watch().then(stream => {
            // Connected
            $('form input')[0].removeAttribute('disabled');
            $('.status').text('Connected');
            if (!connectedOnce) {
              connectedOnce = true;
              messagesCollection.find({}, {sort: {postedOn: 1}}).toArray().then(messages => {
                // Add past messages
                _.each(messages, function(message) {
                  $('.room').append(makeMessage(message));
                })
                scrollChatToBottom();
              })
            }

            stream.onNext(event => {
              if (event.operationType != 'insert') {
                return;
              }
              $('.room').append(makeMessage(event.fullDocument));
              scrollChatToBottom();
              $('.message:last').effect('highlight', {color: '#d9edf7'}, 500);
            });

            stream.onError(error => {
              $('form input')[0].setAttribute('disabled', true);
              $('.status').text('Disconnected');
              setTimeout(function() { startChat(); }, 2000);
            });            
          });
        }

        function scrollChatToBottom() {
          $('.room').scrollTop($('.room')[0].scrollHeight);
        }

        const converter = new showdown.Converter();
        // https://gist.github.com/sindresorhus/1993156
        const stripScripts = function(a,b,c){b=new Option;b.innerHTML=a;for(a=b.getElementsByTagName('script');c=a[0];)c.parentNode.removeChild(c);return b.innerHTML};
        function makeMessage(messageObj) {
          var newMessage = $('<div class="row message">');
          var dateField = messageObj.postedOn ? moment(messageObj.postedOn).format('MM/DD HH:mm:ss') : 'N/A';
          var usernameField = messageObj.username || 'N/A';
          newMessage.append($('<span class="col-md-1">').text(dateField));
          newMessage.append($('<span class="col-md-1">').text(usernameField));
          newMessage.append($('<div class="col-md-8">').html(stripScripts(converter.makeHtml(messageObj.message))));
          return newMessage;
        }
      });
    </script>

  </body>

</html>
